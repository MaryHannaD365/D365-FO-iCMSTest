---
# required metadata

title: Fiscal printer integration sample for Italy
description: This topic provides an overview of the fiscal integration sample for Italy.
author: josaw
manager: annbe
ms.date: 11/01/2018
ms.topic: article
ms.prod: 
ms.service: dynamics-365-retail
ms.technology: 

# optional metadata

ms.search.form: RetailFunctionalityProfile, RetailFormLayout, RetailParameters
audience: Application User
# ms.devlang: 
ms.reviewer: josaw
ms.search.scope: Core, Operations, Retail
# ms.tgt_pltfrm: 
# ms.custom: 
ms.search.region: Italy
ms.search.industry: Retail
ms.author: sepism
ms.search.validFrom: 2018-11-1
ms.dyn365.ops.version: 8.1.1

---
# Fiscal printer integration sample for Italy

[!include[banner](../includes/banner.md)]

## Overview

The fiscal integration for Italy includes samples of the integration with the fiscal printer EPSON FP-90III. This was developed based on the fiscal integration framework. For details about the fiscal integration functionality, see [Fiscal integration for Retail channel](fiscal-integration-for-retail-channel.md).

This sample includes the following functionality:
- Integration with fiscal printer Epson FP-90III via web-service mode - ePOS-Print solution.
- Registration of the following events in POS:
	- Print receipt for sale:
	  - Print receipt for sale return.
	  - Print X report.
	  - Print Z report.

Receipts for sale and sale return operations also support the following scenarios:  
- Printing of discounts.
- Excluding gift cards from the receipt.
- Receipts to customer order.

## Design

The integration for the fiscal printer Epson FP-90III is implemented in two extensions:
- CRT extension - Generates XML documents in printer-specific format (Runtime.Extensions.DocumentProvider.EpsonFP90IIISample).
- Hardware station extension - Submits documents generated by CRT extension to the fiscal printer (via HTTP protocol) and handles the response from HardwareStation.Extensions.EpsonFP90IIIFiscalDeviceSample.

![alt text](media/emea-ita-fpi-solution.png "Solution schema")

## Set up Retail for Italy

### Enabling extensions

##### CRT extension components

The CRT extension components are included in the Retail SDK. To complete the following procedures, open the CRT solution, CommerceRuntimeSamples.sln, under RetailSdk\SampleExtensions\CommerceRuntime.

1. Find the Runtime.Extensions.DocumentProvider.EpsonFP90IIISample project and build it.
1. In the Extensions.DocumentProvider.EpsonFP90IIISample\bin\Debug folder, find the Contoso.Commerce.Runtime.DocumentProvider.EpsonFP90IIISample.dll assembly file.
1. Copy the assembly file to the CRT extensions folder:
	- Retail Server: Copy the assembly to the \bin\ext folder under the Microsoft Internet Information Services (IIS) Retail Server site location.
	- Local CRT on Modern POS: Copy the assembly to the \ext folder under the local CRT client broker location.
1. Find the extensions configuration file for CRT:
	- Retail Server: The file is named commerceruntime.ext.config, and it's in the bin\ext folder under the IIS Retail Server site location.
	- Local CRT on Modern POS: The file is named CommerceRuntime.MPOSOffline.Ext.config, and it's under the local CRT client broker location.
1. Register the CRT change in the extensions configuration file. Add source="assembly" value="Contoso.Commerce.Runtime.DocumentProvider.EpsonFP90IIISample" 
1. Restart the Retail service:
	- Retail Server: Restart the Retail service site from IIS Manager.
	- Client broker: End the dllhost.exe process in Task Manager, and then restart Modern POS.

##### Hardware station extension components
The Hardware station extension components are included in the Retail SDK. To complete the following procedures, open the Hardware Station solution, HardwareStationSamples.sln, under RetailSdk\SampleExtensions\HardwareStation.

1. Find the HardwareStation.Extensions.EpsonFP90IIIFiscalDeviceSample project and build it.
1. In the Extensions.EpsonFP90IIIFiscalDeviceSample \bin\Debug folder, find the Contoso.Commerce.HardwareStation.EpsonFP90IIIFiscalDeviceSample.dll assembly file.
1. Copy the files to a deployed Hardware station machine:
	- Remote Hardware station: Copy the files to the bin folder under the Microsoft Internet Information Services (IIS) Hardware station site location.
	- Local Hardware station: Copy the files to the Modern POS client broker location.
1. Find the configuration file for the Hardware station's extensions. The file is named HardwareStation.Extension.config:
	- Remote Hardware station: The file is located under the IIS Hardware station site location.
	- Local Hardware station: The file is located under the Modern POS client broker location.
	
1. Add the following section to the composition section of the config file.	
	<add source="assembly" value="Contoso.Commerce.HardwareStation.Extension.EpsonFP90IIIFiscalDeviceSample" />
1. Restart the Hardware station service:
	- Remote Hardware station: Restart the Hardware station site from IIS Manager.
	- Local Hardware station: End the dllhost.exe process in Task Manager, and then restart Modern POS.

### Set up the registration process
To enable the registration process, set up the Headquarters using the following steps:
1. Open Retail\Channel Setup\Fiscal Integration\Fiscal Connectors. Import the configuration from RetailSdk\SampleExtensions\CommerceRuntime\Entension.DocumentProvider.EpsonFP90IIISample\Configuration\DocumentProviderEpsonFP90IIISample.xml.

![alt text](media/emea-ita-fpi-fiscalconnector.png "Fiscal connector")

2. Open Retail\Channel Setup\Fiscal Integration\Fiscal Document providers. Import the configuration from RetailSdk\SampleExtensions\HardwareStation\Entension.EpsonFP90IIIFiscalDeviceSample\Configuration\ConnectorEpsonFP90IIISample.xml.

![alt text](media/emea-ita-fpi-documentprovider.png "Document provider")

3. Open Retail\Channel Setup\Fiscal Integration\Connector Technical profiles. Create a new profile and select the loaded connector from the step above. Update connection settings if needed.

![alt text](media/emea-ita-fpi-technicalprofile.png "Technical profile")

4. Open Retail\Channel Setup\Fiscal Integration\Connector Functional profiles. Create a new profile and select the loaded connector and document provider from the steps above. Update data mapping settings if needed

![alt text](media/emea-ita-fpi-fiscalfunctionalityprofile.png "Connector functional profile")

5. Open Retail\Channel Setup\Fiscal Integration\Connector Functional group. Create a new group and select the connector functional profile from the step above.

![alt text](media/emea-ita-fpi-connectorgroup.png "Connector group")

6. Open Retail\Channel Setup\Fiscal Integration\Registration process. Create a new process. Select the connector functional group from the step above.

![alt text](media/emea-ita-fpi-registrationprocess.png "Registration process")

7. Open Functionality profile linked to the store where the registration process should be activated. Expand the **Fiscal registration process** FastTab. Select the created registration process from the step above.

![alt text](media/emea-ita-fpi-functionalityprofile.png "POS functionality profile")

8. Open the Hardware profile that is linked to the hardware station to which the fiscal printer will be connected. Expand the **Fiscal peripherals** FastTab. Select the connector technical profile.

![alt text](media/emea-ita-fpi-hardwareprofile.png "Hardware profile")

9. Open Distribution scheduler and select job **1070** to transfer data to the Channel database.

![alt text](media/emea-ita-fpi-distributionjobs.png "Distribution scheduler")

## Commerce runtime extension design

The purpose of the extension (Document provider) is to generate printer-specific documents and handle responses from the fiscal printer. 

### Request handler
	
The request handler DocumentProviderEpsonFP90III is the entry point for the request to generate documents from the fiscal printer.

The handler is inherited from the INamedRequestHandler interface. The Method HandlerName is responsible for returning the name of the handler. It should match the connector document provider name specified in HQ.

The connector supports the following requests:
- GetFiscalDocumentDocumentProviderRequest- Contains information about what document should be generated. Returns a printer-specific document that should be registered in the fiscal printer.
- GetSupportedRegistrableEventsDocumentProviderRequest - Returns the list of events to subscribe to. Currently, the following events are supported: sales, printing X report, and printing Z report.
- SaveFiscalRegistrationResultDocumentProviderRequest- Saves the response from the printer.


### Configuration
The configuration file is found in the Configuration folder of the extension project. The purpose of the file is to allow to configure settings for the document provider from the HQ. The file format aligns fiscal integration configuration requirements. The following settings have been added:
- VAT rates mapping
- Tender type mapping

## Hardware station extension design

The purpose of the extension (Connector) is to communicate with the fiscal printer.

### Request handler
The request handler EpsonFP90IIISample is the entry point for handling request to the fiscal peripheral device. The handler is inherited from INamedRequestHandler interface. Method HandlerName is responsible for returning the name of the handler, it should match the fiscal connector name specified in HQ.

The connector supports the following requests:
- SubmitDocumentFiscalDeviceRequest - Sends document to printers and returns response from the fiscal printer.
- IsReadyFiscalDeviceRequest - Used for a health check of the device.
- InitializeFiscalDeviceRequest - Used for printer initialization.


### Configuration
The configuration file is found in **Configuration** folder of the extension project. The purpose of the file is to allow to configure settings for the connector provider from the HQ. The file format aligned fiscal Integration configuration requirements. The following settings have been added:
- Endpoint address - URL of the printer.
- Date and time synchronization - This indicates if you need to the sync date and time of the printer with the connected hardware station. The date and time of the printer will be synchronized with the Hardware station time.
